name: Deploy Cloud Functions

on:
  workflow_call:
    inputs:
      function_name:
        description: 'Cloud Functionの名前'
        required: true
        type: string
      project_id:
        description: '関数をデプロイするGoogle CloudプロジェクトID'
        required: true
        type: string
      region:
        description: '関数を配置するGoogle Cloudリージョン'
        required: true
        type: string
      service_account_name:
        description: 'サービスアカウント名（例: my-sa-name）'
        required: true
        type: string
      gcp_project_number:
        description: 'Google Cloudプロジェクト番号（Workload Identity用）'
        required: true
        type: string
      wip_pool_name:
        description: 'Workload Identityプール名'
        required: false
        type: string
        default: 'github-actions-pool'
      wip_provider_name:
        description: 'Workload Identityプロバイダー名'
        required: false
        type: string
        default: 'github-provider'
      secrets_project_id:
        description: 'シークレットが格納されているGoogle CloudプロジェクトID（未設定時はfunctionのproject_idを使用）'
        required: false
        type: string
      secrets_config:
        description: 'シークレット名の複数行文字列（例: "SECRET_A\nSECRET_B"）'
        required: true
        type: string
      runtime:
        description: 'Cloud Functionのランタイム（例: php82）'
        required: false
        type: string
        default: 'php82'
      source_dir:
        description: '関数コードのソースディレクトリ'
        required: false
        type: string
        default: './'
      http_max_instance_count:
        description: 'HTTPトリガー関数の最大インスタンス数'
        required: false
        type: number
        default: 1
      memory:
        description: '関数に割り当てるメモリ量'
        required: false
        type: string
        default: '256M'
      http_timeout:
        description: 'HTTPトリガー関数のタイムアウト時間'
        required: false
        type: string
        default: '60s'
      event_timeout:
        description: 'イベントトリガー関数のタイムアウト時間'
        required: false
        type: string
        default: '5m'
      gcs_source_dir:
        description: 'Cloud Storageへのコピー元ディレクトリ'
        required: false
        type: string
        default: ''
      gcs_bucket_name:
        description: 'Cloud Storageのコピー先バケット名'
        required: false
        type: string
        default: ''
      gcs_bucket_path:
        description: 'Cloud Storageのコピー先パス'
        required: false
        type: string
        default: ''
      disable_gcs_cache:
        description: 'Cloud Storageでのキャッシュを無効化するかどうか'
        required: false
        type: boolean
        default: false
      deploy_http_trigger:
        description: 'HTTPトリガー関数をデプロイするかどうか'
        required: false
        type: boolean
        default: true
      http_entry_point:
        description: 'HTTPトリガー関数のエントリポイント'
        required: false
        type: string
        default: 'main_http'
      deploy_event_trigger:
        description: 'イベントトリガー関数をデプロイするかどうか'
        required: false
        type: boolean
        default: true
      event_entry_point:
        description: 'イベントトリガー関数のエントリポイント'
        required: false
        type: string
        default: 'main_event'
      event_trigger_pubsub_topic_suffix:
        description: 'イベントトリガーPub/Subトピックのサフィックス（function_nameに付加されます）'
        required: false
        type: string
        default: '-event'
      environment_variables:
        description: '環境変数を KEY=VALUE,KEY2=VALUE2 の形式で渡します'
        required: false
        type: string
        default: ''

permissions:
  contents: 'read'
  id-token: 'write'

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      SECRETS_PROJECT_FOR_CONSTRUCTION: ${{ inputs.secrets_project_id || inputs.project_id }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          submodules: 'true'
          
      - name: Google Cloud認証
        id: 'auth'
        uses: 'google-github-actions/auth@v2'
        with:
          workload_identity_provider: 'projects/${{ inputs.gcp_project_number }}/locations/global/workloadIdentityPools/${{ inputs.wip_pool_name }}/providers/${{ inputs.wip_provider_name }}'
          service_account: '${{ inputs.service_account_name }}@${{ inputs.project_id }}.iam.gserviceaccount.com'

      - name: 'Deployment Configuration Summary'
        shell: bash
        run: |
          echo "::group::Deployment Configuration"
          echo "Function Name: ${{ inputs.function_name }}"
          echo "Project ID: ${{ inputs.project_id }}"
          echo "Region: ${{ inputs.region }}"
          echo "Runtime: ${{ inputs.runtime }}"
          echo "Service Account: ${{ inputs.service_account_name }}@${{ inputs.project_id }}.iam.gserviceaccount.com"
          echo "Source Directory: ${{ inputs.source_dir }}"
          echo "HTTP Trigger: ${{ inputs.deploy_http_trigger }}"
          if [ "${{ inputs.deploy_http_trigger }}" = "true" ]; then
            echo "  Entry Point: ${{ inputs.http_entry_point }}"
            echo "  Max Instances: ${{ inputs.http_max_instance_count }}"
            echo "  Timeout: ${{ inputs.http_timeout }}"
          fi
          echo "Event Trigger: ${{ inputs.deploy_event_trigger }}"
          if [ "${{ inputs.deploy_event_trigger }}" = "true" ]; then
            echo "  Entry Point: ${{ inputs.event_entry_point }}"
            echo "  Timeout: ${{ inputs.event_timeout }}"
            echo "  Pub/Sub Topic: projects/${{ inputs.project_id }}/topics/${{ inputs.function_name }}${{ inputs.event_trigger_pubsub_topic_suffix }}"
          fi
          echo "Memory: ${{ inputs.memory }}"
          echo "::endgroup::"

      - name: Prepare Secrets Configuration
        id: prep_secrets
        shell: bash
        run: |
          echo "::group::Preparing secrets configuration"
          secrets_config_input="${{ inputs.secrets_config }}"
          secrets_array=()
          readarray -t secrets_array <<< "$secrets_config_input"
          
          secrets_output=""
          first_secret=true

          for secret_name in "${secrets_array[@]}"; do
            if [ -z "$secret_name" ]; then
              continue
            fi

            echo "Adding secret: $secret_name"

            if [ "$first_secret" = false ]; then
              secrets_output="${secrets_output},"
            fi

            secrets_output="${secrets_output}${secret_name}=projects/${{ env.SECRETS_PROJECT_FOR_CONSTRUCTION }}/secrets/${secret_name}/versions/latest"
            first_secret=false
          done
          
          echo "formatted_secrets<<EOF" >> "$GITHUB_OUTPUT"
          echo -e "$secrets_output" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"
          echo "::endgroup::"

      - name: Mirror local directory to GCS
        if: inputs.gcs_source_dir != '' && inputs.gcs_bucket_name != ''
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 5
          max_attempts: 3
          command: |
            gcloud storage cp -r ${{ inputs.gcs_source_dir }} gs://${{ inputs.gcs_bucket_name }}/${{ inputs.gcs_bucket_path }}

      - name: 'Update Cache-Control metadata for static files'
        if: inputs.disable_gcs_cache && inputs.gcs_source_dir != '' && inputs.gcs_bucket_name != ''
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 5
          max_attempts: 3
          command: |
            gcloud storage objects update gs://${{ inputs.gcs_bucket_name }}/${{ inputs.gcs_bucket_path }}**/* --cache-control="no-cache,no-store,must-revalidate"

      - name: Deploy Cloud Functions (http)
        if: inputs.deploy_http_trigger
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 10
          max_attempts: 3
          command: |
            SECRETS_ARG=""
            if [ -n "${{ steps.prep_secrets.outputs.formatted_secrets }}" ]; then
              SECRETS_ARG="--set-secrets=${{ steps.prep_secrets.outputs.formatted_secrets }}"
            fi

            ENV_VARS_ARG=""
            if [ -n "${{ inputs.environment_variables }}" ]; then
              ENV_VARS_ARG="--set-env-vars=${{ inputs.environment_variables }}"
            fi

            gcloud functions deploy ${{ inputs.function_name }} \
              --gen2 \
              --project=${{ inputs.project_id }} \
              --region=${{ inputs.region }} \
              --runtime=${{ inputs.runtime }} \
              --entry-point=${{ inputs.http_entry_point }} \
              --source=${{ inputs.source_dir }} \
              --service-account=${{ inputs.service_account_name }}@${{ inputs.project_id }}.iam.gserviceaccount.com \
              --max-instances=${{ inputs.http_max_instance_count }} \
              --memory=${{ inputs.memory }} \
              --timeout=${{ inputs.http_timeout }} \
              $SECRETS_ARG \
              $ENV_VARS_ARG \
              --trigger-http \
              --quiet

      - name: 'Allow Public Access (Cloud Functions)'
        if: inputs.deploy_http_trigger && contains(inputs.environment_variables, 'APP_ENV=test')
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 2
          max_attempts: 3
          command: |
            gcloud functions add-iam-policy-binding ${{ inputs.function_name }} \
              --project=${{ inputs.project_id }} \
              --region=${{ inputs.region }} \
              --member="allUsers" \
              --role="roles/cloudfunctions.invoker"

      - name: 'Allow Public Access (Cloud Run)'
        if: inputs.deploy_http_trigger && contains(inputs.environment_variables, 'APP_ENV=test')
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 2
          max_attempts: 3
          command: |
            gcloud run services add-iam-policy-binding ${{ inputs.function_name }} \
              --project=${{ inputs.project_id }} \
              --region=${{ inputs.region }} \
              --member="allUsers" \
              --role="roles/run.invoker"

      - name: Deploy Cloud Functions (event)
        if: inputs.deploy_event_trigger
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 10
          max_attempts: 3
          command: |
            SECRETS_ARG=""
            if [ -n "${{ steps.prep_secrets.outputs.formatted_secrets }}" ]; then
              SECRETS_ARG="--set-secrets=${{ steps.prep_secrets.outputs.formatted_secrets }}"
            fi

            ENV_VARS_ARG=""
            if [ -n "${{ inputs.environment_variables }}" ]; then
              ENV_VARS_ARG="--set-env-vars=${{ inputs.environment_variables }}"
            fi

            gcloud functions deploy ${{ inputs.function_name }}${{ inputs.event_trigger_pubsub_topic_suffix }} \
              --gen2 \
              --project=${{ inputs.project_id }} \
              --region=${{ inputs.region }} \
              --runtime=${{ inputs.runtime }} \
              --entry-point=${{ inputs.event_entry_point }} \
              --source=${{ inputs.source_dir }} \
              --service-account=${{ inputs.service_account_name }}@${{ inputs.project_id }}.iam.gserviceaccount.com \
              --max-instances=1 \
              --memory=${{ inputs.memory }} \
              --timeout=${{ inputs.event_timeout }} \
              $SECRETS_ARG \
              $ENV_VARS_ARG \
              --trigger-topic=projects/${{ inputs.project_id }}/topics/${{ inputs.function_name }}${{ inputs.event_trigger_pubsub_topic_suffix }} \
              --quiet
