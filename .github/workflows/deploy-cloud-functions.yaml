name: Deploy Cloud Functions

on:
  workflow_call:
    inputs:
      function_name:
        description: 'Cloud Functionの名前'
        required: true
        type: string
      project_id:
        description: '関数をデプロイするGoogle CloudプロジェクトID'
        required: true
        type: string
      region:
        description: '関数を配置するGoogle Cloudリージョン'
        required: true
        type: string
      service_account_name:
        description: 'サービスアカウント名（例: my-sa-name）'
        required: true
        type: string
      gcp_project_number:
        description: 'Google Cloudプロジェクト番号（Workload Identity用）'
        required: true
        type: string
      wip_pool_name:
        description: 'Workload Identityプール名'
        required: false
        type: string
        default: 'github-actions-pool'
      wip_provider_name:
        description: 'Workload Identityプロバイダー名'
        required: false
        type: string
        default: 'github-provider'
      secrets_project_id:
        description: 'シークレットが格納されているGoogle CloudプロジェクトID（未設定時はfunctionのproject_idを使用）'
        required: false
        type: string
      secrets_config:
        description: 'シークレット名の複数行文字列（例: "SECRET_A\nSECRET_B"）'
        required: true
        type: string
      runtime:
        description: 'Cloud Functionのランタイム（例: php82）'
        required: false
        type: string
        default: 'php82'
      source_dir:
        description: '関数コードのソースディレクトリ'
        required: false
        type: string
        default: './'
      max_instance_count:
        description: '関数の最大インスタンス数'
        required: false
        type: number
        default: 1
      deploy_http_trigger:
        description: 'HTTPトリガー関数をデプロイするかどうか'
        required: false
        type: boolean
        default: true
      http_entry_point:
        description: 'HTTPトリガー関数のエントリポイント'
        required: false
        type: string
        default: 'main_http'
      deploy_event_trigger:
        description: 'イベントトリガー関数をデプロイするかどうか'
        required: false
        type: boolean
        default: true
      event_entry_point:
        description: 'イベントトリガー関数のエントリポイント'
        required: false
        type: string
        default: 'main_event'
      event_trigger_pubsub_topic_suffix:
        description: 'イベントトリガーPub/Subトピックのサフィックス（function_nameに付加されます）'
        required: false
        type: string
        default: '-event'

permissions:
  contents: 'read'
  id-token: 'write'

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      # Determine the project ID for secrets. Use inputs.secrets_project_id if provided, otherwise default to inputs.project_id
      SECRETS_PROJECT_FOR_CONSTRUCTION: ${{ inputs.secrets_project_id || inputs.project_id }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          submodules: 'true'
          
      - name: Google Cloud認証
        id: 'auth'
        uses: 'google-github-actions/auth@v2'
        with:
          workload_identity_provider: 'projects/${{ inputs.gcp_project_number }}/locations/global/workloadIdentityPools/${{ inputs.wip_pool_name }}/providers/${{ inputs.wip_provider_name }}'
          service_account: '${{ inputs.service_account_name }}@${{ inputs.project_id }}.iam.gserviceaccount.com'

      - name: Prepare Secrets Configuration
        id: prep_secrets
        shell: bash
        run: |
          echo "--- Debugging secrets_config_input ---"
          echo "${{ inputs.secrets_config }}"
          echo "--- End Debugging ---"

          secrets_config_input="${{ inputs.secrets_config }}"
          
          echo "--- Debugging secrets_array population ---"
          echo "secrets_config_input received: '${secrets_config_input}'"

          secrets_array=()
          # inputs.secrets_config が改行区切りであることを前提に、配列に読み込み
          # read -r -a を使用し、IFS=$'\n' で改行を区切り文字とする
          # <<< "$secrets_config_input" はhere-stringで、変数を標準入力として渡す
          IFS=$'\n' read -r -a secrets_array <<< "$secrets_config_input"
          
          echo "secrets_array contents:"
          printf '%s\n' "${secrets_array[@]}"
          echo "Array length: ${#secrets_array[@]}"
          echo "--- End Debugging secrets_array ---"

          # formatted_secrets を改行区切りで出力するため、テンポラリファイルを使用
          # または配列に一度格納し、後でjoinする手もありますが、ここではbashで直接構築
          formatted_secrets_lines=()

          echo "--- Debugging loop execution ---"
          for secret_name in "${secrets_array[@]}"; do
            echo "Looping with secret_name: '$secret_name'"
            if [ -n "$secret_name" ]; then # 空行をスキップ
              # 各シークレットのフォーマット済み文字列を配列に追加
              formatted_secrets_lines+=("${secret_name}=projects/${{ env.SECRETS_PROJECT_FOR_CONSTRUCTION }}/secrets/${secret_name}/versions/latest")
              echo "Added line: '${formatted_secrets_lines[-1]}'"
            else
              echo "Skipping empty secret_name."
            fi
          done
          echo "--- End Debugging loop execution ---"
          
          # formatted_secrets_lines 配列の要素を改行で結合
          # IFS=$'\n' を使って配列をjoin
          printf -v secrets_output '%s\n' "${formatted_secrets_lines[@]}"
          
          echo "secrets_output after loop (main shell before GITHUB_OUTPUT):\n'$secrets_output'"

          echo "formatted_secrets<<EOF" >> "$GITHUB_OUTPUT"
          # -e を使うとバックスラッシュエスケープが解釈されるため、
          # 改行をそのまま出力したい場合は -e なしでも良いですが、
          # こちらは問題ないので維持します。
          echo "$secrets_output" >> "$GITHUB_OUTPUT" 
          echo "EOF" >> "$GITHUB_OUTPUT"

          echo "--- Debugging GITHUB_OUTPUT ---"
          # GITHUB_OUTPUTに書き込まれた値を確認するために、
          # このステップの直後にformatted_secretsを参照する別のステップを追加し、
          # そのステップでechoしてみてください。
          echo "--- End Debugging ---"
      - name: Secrets
        shell: bash
        run: echo "${{ steps.prep_secrets.outputs.formatted_secrets }}"

      - name: Deploy Cloud Functions (http)
        if: inputs.deploy_http_trigger
        uses: 'google-github-actions/deploy-cloud-functions@v3'
        timeout-minutes: 5
        with:
          name: ${{ inputs.function_name }}
          project_id: ${{ inputs.project_id }}
          region: ${{ inputs.region }}
          runtime: ${{ inputs.runtime }}
          entry_point: ${{ inputs.http_entry_point }}
          service_account: '${{ inputs.service_account_name }}@${{ inputs.project_id }}.iam.gserviceaccount.com'
          source_dir: ${{ inputs.source_dir }}
          max_instance_count: ${{ inputs.max_instance_count }}
          secrets: ${{ steps.prep_secrets.outputs.formatted_secrets }}

      - name: Deploy Cloud Functions (event)
        if: inputs.deploy_event_trigger
        uses: 'google-github-actions/deploy-cloud-functions@v3'
        timeout-minutes: 5
        with:
          name: ${{ inputs.function_name }}${{ inputs.event_trigger_pubsub_topic_suffix }}
          project_id: ${{ inputs.project_id }}
          region: ${{ inputs.region }}
          runtime: ${{ inputs.runtime }}
          entry_point: ${{ inputs.event_entry_point }}
          event_trigger_type: google.cloud.pubsub.topic.v1.messagePublished
          event_trigger_pubsub_topic: projects/${{ inputs.project_id }}/topics/${{ inputs.function_name }}${{ inputs.event_trigger_pubsub_topic_suffix }}
          service_account: '${{ inputs.service_account_name }}@${{ inputs.project_id }}.iam.gserviceaccount.com'
          source_dir: ${{ inputs.source_dir }}
          max_instance_count: ${{ inputs.max_instance_count }}
          secrets: ${{ steps.prep_secrets.outputs.formatted_secrets }}
